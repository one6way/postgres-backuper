# Вариант 2: Встраивание сертификатов в образ Spark

## Описание

Данный вариант предполагает встраивание сертификатов непосредственно в Docker-образ Spark во время его сборки. Такой подход позволяет избежать динамического монтирования сертификатов в контейнеры во время выполнения и упрощает развертывание Spark-приложений.

## Преимущества

- **Простота развертывания**: Сертификаты уже встроены в образ, не требуется дополнительная конфигурация Kubernetes
- **Улучшенная безопасность**: Сертификаты включены в образ, доступ к ним имеет только приложение
- **Независимость от внешней инфраструктуры**: Нет зависимости от Kubernetes Secrets или других внешних хранилищ секретов
- **Более быстрый запуск**: Отсутствие необходимости монтирования секретов при запуске контейнеров

## Недостатки

- **Сложность обновления сертификатов**: При истечении срока действия сертификатов требуется перестройка и переразвертывание образа
- **Версионирование образов**: Необходимо отслеживать версии образов с разными сертификатами
- **Больший размер образа**: Дополнительные файлы увеличивают размер Docker-образа
- **Возможные проблемы с безопасностью**: Если образ скомпрометирован, то доступны и сертификаты

## Схема взаимодействия

```
┌─────────────────────┐     ┌───────────────────────┐
│                     │     │                       │
│  CI/CD Пайплайн     │────▶│  Сборка Docker образа │
│                     │     │  с сертификатами      │
└─────────────────────┘     └───────────────────────┘
                                      │
                                      ▼
┌─────────────────────┐     ┌───────────────────────┐
│                     │     │                       │
│  Docker Registry    │◀────│  Публикация образа    │
│                     │     │                       │
└─────────────────────┘     └───────────────────────┘
        │
        │
        ▼
┌─────────────────────┐     ┌───────────────────────┐
│                     │     │                       │
│  Kubernetes Cluster │◀────│  Загрузка образа и    │
│                     │     │  запуск приложения    │
└─────────────────────┘     └───────────────────────┘
        │
        │
        ▼
┌─────────────────────┐
│                     │
│  Spark Application  │────▶ Соединение с Kafka
│  с сертификатами    │     используя встроенные
│                     │     сертификаты
└─────────────────────┘
```

## Процесс реализации

1. Создание Dockerfile для сборки образа Spark с включенными сертификатами
2. Настройка CI/CD пайплайна для автоматической сборки и публикации образа
3. Обновление конфигурации Spark-приложения для использования путей к сертификатам внутри контейнера
4. Настройка процесса обновления образа при истечении срока действия сертификатов

## Пример Dockerfile

```dockerfile
FROM apache/spark:3.3.0

# Копирование сертификатов в образ
COPY ./certs/kafka.client.keystore.jks /opt/spark/certs/
COPY ./certs/kafka.client.truststore.jks /opt/spark/certs/

# Установка прав доступа
RUN chmod 400 /opt/spark/certs/* && \
    chown -R 185:185 /opt/spark/certs/

# Настройка переменных окружения для Spark
ENV SPARK_KAFKA_KEYSTORE=/opt/spark/certs/kafka.client.keystore.jks
ENV SPARK_KAFKA_TRUSTSTORE=/opt/spark/certs/kafka.client.truststore.jks
```

## Конфигурация SparkSession

```python
spark = SparkSession.builder \
    .appName("Kafka-Spark-ADB") \
    .config("spark.kafka.ssl.keystore.location", os.environ.get("SPARK_KAFKA_KEYSTORE")) \
    .config("spark.kafka.ssl.truststore.location", os.environ.get("SPARK_KAFKA_TRUSTSTORE")) \
    .config("spark.kafka.ssl.keystore.password", os.environ.get("KEYSTORE_PASSWORD")) \
    .config("spark.kafka.ssl.truststore.password", os.environ.get("TRUSTSTORE_PASSWORD")) \
    .getOrCreate()
```

## Безопасная передача паролей

Хотя сертификаты встроены в образ, пароли к хранилищам должны передаваться отдельно через:
- Переменные окружения в Kubernetes deployments/SparkApplication
- Kubernetes Secrets для паролей
- Аргументы командной строки при запуске Spark Submit 